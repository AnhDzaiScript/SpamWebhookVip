<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JS Deobfuscator – Anti-eval</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111;background:#0b1220;margin:0}
  header{padding:16px 20px;background:#0e1730;border-bottom:1px solid #223}
  h1{margin:0;font-size:18px;color:#fff}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:14px;align-items:stretch}
  textarea{width:100%;height:360px;resize:vertical;background:#0e162a;color:#e8f0ff;border:1px solid #223;border-radius:8px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace;font-size:13px;line-height:1.5}
  .col{flex:1;display:flex;flex-direction:column}
  .btns{display:flex;gap:8px;margin:10px 0 0}
  button{background:#2463eb;border:0;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
  button.secondary{background:#1f2937}
  button.warn{background:#b91c1c}
  small,label{color:#9fb0d1}
  .status{margin-top:8px;color:#a7f3d0}
  .note{color:#9fb0d1;margin-top:8px}
</style>
<!-- Prettier (tùy chọn, có mạng thì sẽ format đẹp) -->
<script defer src="https://unpkg.com/prettier@3.3.3/standalone.js"></script>
<script defer src="https://unpkg.com/prettier@3.3.3/plugins/babel.js"></script>
</head>
<body>
<header><h1>JS Deobfuscator – chống eval / Function / document.write</h1></header>

<div class="wrap">
  <div class="row">
    <div class="col">
      <label>Input (mã bị mã hoá/obfuscate)</label>
      <textarea id="input" placeholder="Dán mã vào đây..."></textarea>
      <div class="btns">
        <button id="decode">Giải mã</button>
        <button id="beautify" class="secondary">Beautify (Prettier)</button>
        <button id="clear" class="warn">Xoá</button>
      </div>
      <div class="note">Mẹo: dán cả dạng <code>document.write(unescape('%3Cscript...'))</code>,
        <code>decodeURIComponent</code>, hay <code>Function('...')</code> đều được.</div>
    </div>
    <div class="col">
      <label>Output (kết quả đã bung)</label>
      <textarea id="output" placeholder="Kết quả sẽ hiện ở đây..."></textarea>
      <div class="status" id="status"></div>
    </div>
  </div>
</div>

<script>
/* --------- Helpers giải chuỗi escape ---------- */
function tryDecodeUri(s){try{return decodeURIComponent(s)}catch{return s}}
function tryUnescape(s){try{return unescape(s)}catch{return s}} // legacy nhưng hữu ích
function decodeHexEscapes(s){
  // \xNN
  s = s.replace(/\\x([0-9a-fA-F]{2})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  // \uNNNN
  s = s.replace(/\\u([0-9a-fA-F]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  // \NNN (octal, cẩn thận – chỉ các case phổ biến)
  s = s.replace(/\\([0-7]{2,3})/g, (_,o)=>String.fromCharCode(parseInt(o,8)));
  return s;
}
function basicStringPass(s){
  let t = s;
  if (/%[0-9A-Fa-f]{2}/.test(t)) t = tryDecodeUri(t);
  t = tryUnescape(t);
  t = decodeHexEscapes(t);
  // gỡ bọc document.write('...') đơn giản
  t = t.replace(/document\.write\s*\(\s*(['"])([\s\S]*?)\1\s*\)\s*;?/g, (_,q,body)=>body);
  return t;
}

/* --------- Sandbox bắt eval/Function/document.write ---------- */
function runInTrap(code){
  const captured = [];
  // sandbox object giới hạn API
  const sandbox = {
    console:{log:(...a)=>captured.push(a.join(" ")), error:()=>{}, warn:()=>{}},
    document:{
      write:(x)=>{ if (typeof x === "string") captured.push(x); },
      open:()=>{}, close:()=>{}
    },
    window:null, globalThis:null, self:null,
    atob:(s)=>{ try{ const r = atob(s); captured.push(r); return r; }catch{ return ""; } },
    btoa:()=>"", alert:()=>{},
    setTimeout:(fn,ms)=>{ /* không chạy */ },
    setInterval:()=>{},
    eval:(src)=>{ if (typeof src==="string") captured.push(String(src)); return ""; },
    Function:function(...args){
      const body = String(args[args.length-1]||"");
      captured.push(body);
      // trả về hàm giả, không thực thi
      return function(){ return ""; };
    }
  };
  sandbox.window = sandbox.globalThis = sandbox.self = sandbox;

  // thực thi trong with(sandbox){ ... } để chặn truy cập global
  const runner = new Function("sandbox","with(sandbox){\ntry{"+code+"\n}catch(e){} }");
  try { runner(sandbox); } catch(e) { /* bỏ qua */ }

  // lấy ra chuỗi dài nhất (thường là code thật nhất)
  const best = captured.sort((a,b)=>b.length-a.length)[0] || "";
  return {captured, best};
}

/* --------- Giải mã nhiều vòng ---------- */
function deobMultiple(code, maxRounds=8){
  let cur = String(code);
  let status = [];
  for (let i=1;i<=maxRounds;i++){
    const before = cur;
    // Pass 1: giải chuỗi escape cơ bản
    cur = basicStringPass(cur);

    // Pass 2: bẫy eval/Function/doc.write
    const {best, captured} = runInTrap(cur);
    if (best && best.length > 0 && best.length <= 5_000_000) {
      cur = best;
      status.push(`Vòng ${i}: bắt được ${captured.length} chuỗi, chọn dài ${best.length} ký tự`);
    } else {
      status.push(`Vòng ${i}: không còn gì đáng bung`);
    }

    // Nếu không tiến triển thì dừng
    if (cur === before) break;
  }
  return {result:cur, log:status.join("\n")};
}

/* --------- UI ---------- */
const $in = document.getElementById("input");
const $out = document.getElementById("output");
const $status = document.getElementById("status");
document.getElementById("decode").onclick = ()=>{
  const code = $in.value || "";
  if (!code.trim()){ $status.textContent = "Hãy dán mã vào ô Input."; return; }
  const {result, log} = deobMultiple(code);
  $out.value = result;
  $status.textContent = log || "Xong.";
};
document.getElementById("clear").onclick = ()=>{
  $in.value = ""; $out.value = ""; $status.textContent = "";
};
document.getElementById("beautify").onclick = async ()=>{
  try{
    // Prettier qua CDN (nếu offline sẽ ném lỗi)
    const r = prettier.format($out.value||$in.value||"", { parser:"babel", plugins:[prettierPlugins.babel] });
    $out.value = r; $status.textContent = "Đã beautify bằng Prettier.";
  }catch(e){
    $status.textContent = "Beautify lỗi (có thể do không tải được Prettier CDN).";
  }
};
</script>
</body>
</html>
